{% extends 'uploader/base.html' %}
{% load custom_filters %}

{% block title %}Dashboard - IRIDA Uploader Web{% endblock %}

{% block content %}
<!-- Add warning message for inactive users -->
{% if not user.is_active %}
<div class="mb-8">
    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-lg">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Your username is not active</h3>
                <div class="mt-2 text-sm text-red-700">
                    <p>Your username is currently inactive. Please contact support to activate your account before attempting to use this service.</p>
                    <p class="mt-1">Email: <a href="mailto:support@quadram-institute.atlassian.net" class="underline">support@quadram-institute.atlassian.net</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if user.is_active %}
<div x-data="{ 
    showUploadModal: false,
    showForceUploadConfirm: false,
    folders: [],
    selectedFolder: '',
    projectName: '',
    uploads: {{ uploads.object_list|safe }},
    notifications: [],
    uploadProgress: 0,
    currentUploadId: null,
    error: '',
    sampleCount: 0,
    pendingUpload: null,
    uploadLogs: [],
    showLogs: false,
    currentPage: {{ uploads.number }},
    searchQuery: '{{ request.GET.search|default:"" }}',
    showDirectoryInfo: true,
    loading: false,
    projectPrefix: 'QIB',
    appendDate: true,

    goToPage(page) {
        const url = new URL(window.location);
        url.searchParams.set('page', page);
        if (this.searchQuery) {
            url.searchParams.set('search', this.searchQuery);
        }
        window.location = url.toString();
    },

    submitSearch(event) {
        event.preventDefault();
        const url = new URL(window.location);
        if (this.searchQuery) {
            url.searchParams.set('search', this.searchQuery);
        } else {
            url.searchParams.delete('search');
        }
        url.searchParams.delete('page'); // Reset to first page on new search
        window.location = url.toString();
    },

    closeModals() {
        this.showUploadModal = false;
        this.showForceUploadConfirm = false;
        this.error = '';
        this.selectedFolder = '';
        this.projectName = '';
        this.pendingUpload = null;
    },

    async getFolders() {
        this.loading = true;
        try {
            const response = await fetch('{% url 'uploader:get_folders' %}');
            const data = await response.json();
            this.folders = data.folders;
        } catch (err) {
            console.error('Error fetching folders:', err);
        } finally {
            this.loading = false;
        }
    },

    async refreshFolders() {
        await this.getFolders();
    },

    async checkFolderStatus() {
        if (!this.selectedFolder) return;

        try {
            const response = await fetch('{% url 'uploader:upload_files' %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    folder_name: this.selectedFolder,
                    check_only: true
                })
            });
            const data = await response.json();
            
            if (data.status === 'warning' && data.needs_force) {
                this.sampleCount = data.sample_count;
                this.showForceUploadConfirm = true;
                this.showUploadModal = false;
            }
        } catch (err) {
            console.error('Error checking folder status:', err);
            this.error = 'Error checking folder status';
        }
    },

    async startUpload(force = false) {
        if (!this.selectedFolder) {
            this.error = 'Please select a folder first.';
            return;
        }

        // Construct the project name with optional date
        const today = new Date();
        const date = this.appendDate ? 
            '-' + today.getFullYear().toString().slice(-2) + 
            String(today.getMonth() + 1).padStart(2, '0') + 
            String(today.getDate()).padStart(2, '0') : '';
                     
        const folderNameFormatted = this.selectedFolder.replace(/_/g, '-');
        const fullProjectName = this.projectPrefix + '-' + 
            (this.projectName ? this.projectName : folderNameFormatted) + 
            date;

        if (!force) {
            // Check folder status before proceeding with upload
            try {
                const response = await fetch('{% url 'uploader:upload_files' %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        folder_name: this.selectedFolder,
                        check_only: true
                    })
                });
                const data = await response.json();
                
                if (data.status === 'warning' && data.needs_force) {
                    this.sampleCount = data.sample_count;
                    this.showForceUploadConfirm = true;
                    this.showUploadModal = false;
                    return;
                }
            } catch (err) {
                console.error('Error checking folder status:', err);
                this.error = 'Error checking folder status';
                return;
            }
        }

        try {
            // Proceed with upload
            const response = await fetch('{% url 'uploader:upload_files' %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    folder_name: this.selectedFolder,
                    project_name: fullProjectName,
                    force_upload: force
                })
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                this.currentUploadId = data.upload_id;
                this.pollUploadStatus();
                this.showUploadModal = false;
                this.showForceUploadConfirm = false;
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                this.error = data.message || 'Upload failed. Please try again.';
            }
        } catch (err) {
            this.error = 'An error occurred during upload.';
            console.error('Upload error:', err);
        }
    },

    async pollUploadStatus() {
        if (!this.currentUploadId) return;

        try {
            const response = await fetch(`{% url 'uploader:get_upload_status' 0 %}`.replace('0', this.currentUploadId));
            const data = await response.json();
            
            const upload = this.uploads.find(u => u.id === this.currentUploadId);
            if (upload) {
                upload.status = data.status;
                upload.files = data.files;
                if (data.logs) {
                    this.uploadLogs = data.logs;
                    // Auto-scroll to bottom of logs
                    this.$nextTick(() => {
                        const logsContainer = document.querySelector('.logs-container');
                        if (logsContainer) {
                            logsContainer.scrollTop = logsContainer.scrollHeight;
                        }
                    });
                }
            }

            if (data.status === 'uploading' || data.status === 'submitted') {
                setTimeout(() => this.pollUploadStatus(), 2000);
            }
        } catch (err) {
            console.error('Error polling upload status:', err);
        }
    },

    async getNotifications() {
        try {
            const response = await fetch('{% url 'uploader:get_notifications' %}');
            const data = await response.json();
            this.notifications = data.notifications;
        } catch (err) {
            console.error('Error fetching notifications:', err);
        }
    },

    async markNotificationRead(notificationId) {
        try {
            await fetch(`{% url 'uploader:mark_notification_read' 0 %}`.replace('0', notificationId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            this.notifications = this.notifications.filter(n => n.id !== notificationId);
        } catch (err) {
            console.error('Error marking notification as read:', err);
        }
    },

    async updateUploadStatus(uploadId) {
        try {
            const response = await fetch(`{% url 'uploader:get_upload_status' 0 %}`.replace('0', uploadId));
            const data = await response.json();
            
            const uploadIndex = this.uploads.findIndex(u => u.id === uploadId);
            if (uploadIndex !== -1) {
                const oldStatus = this.uploads[uploadIndex].status;
                const newStatus = data.status;
                
                // If status has changed and is now 'success' or 'failed', refresh the page
                if (oldStatus !== newStatus && (newStatus === 'success' || newStatus === 'failed')) {
                    window.location.reload();
                    return;
                }
                
                this.uploads[uploadIndex].status = newStatus;
                this.uploads[uploadIndex].irida_project_id = data.irida_project_id;
                this.uploads[uploadIndex].sample_progress = data.sample_progress;
                if (data.logs) {
                    this.uploadLogs = data.logs;
                }
            }

            if (data.status === 'submitted' || data.status === 'uploading') {
                setTimeout(() => this.updateUploadStatus(uploadId), 2000);
            }
        } catch (err) {
            console.error('Error polling upload status:', err);
        }
    },

    startStatusPolling() {
        this.uploads.forEach(upload => {
            if (upload.status === 'submitted' || upload.status === 'uploading') {
                this.updateUploadStatus(upload.id);
            }
        });
    },

    init() {
        this.getFolders();
        this.getNotifications();
        this.startStatusPolling();
    }
}">
    <div x-data="{ showDirectoryInfo: true }" class="mb-8">
        <div class="bg-blue-50 border-l-4 border-blue-400 rounded-lg overflow-hidden">
            <button @click="showDirectoryInfo = !showDirectoryInfo" 
                    class="w-full px-4 py-3 flex justify-between items-center hover:bg-blue-100/50 focus:outline-none">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                    <h3 class="text-sm font-medium text-blue-800">Upload Directory Information</h3>
                </div>
                <i class="fas transition-transform duration-200" 
                   :class="showDirectoryInfo ? 'fa-chevron-up' : 'fa-chevron-down'">
                </i>
            </button>

            <div x-show="showDirectoryInfo"
                 x-transition:enter="transition ease-out duration-200" 
                 x-transition:enter-start="opacity-0 transform -translate-y-2" 
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-y-0"
                 x-transition:leave-end="opacity-0 transform -translate-y-2"
                 class="px-4 pb-4">
                <div class="ml-3">
                    <div class="mt-2 text-sm text-blue-700">
                        <p>Your upload directory is located at:</p>
                        <code class="bg-blue-100 px-2 py-1 rounded mt-1 block">{{ upload_directory.path }}</code>
                        {% if not upload_directory.exists %}
                            <p class="mt-2 text-yellow-700">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                This directory doesn't exist yet. Please create it manually or use the upload interface to have it created automatically.
                            </p>
                        {% endif %}

                        <p class="mt-2">
                            <i class="fas fa-lightbulb mr-1"></i>
                            Place your subfolders with sequencing files in this directory to make them available for upload to IRIDA.
                        </p>

                        <!-- Added permission warning -->
                        <div class="mt-2 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                            <p class="flex items-start text-yellow-700">
                                <i class="fas fa-exclamation-triangle mt-1 mr-2"></i>
                                <span>
                                    <strong>Important:</strong> Due to HPC permission constraints, please ensure your subfolders have full permissions (chmod 777) before uploading. Otherwise, the upload process may fail.
                                </span>
                            </p>
                        </div>

                        <p class="mt-2">
                            <i class="fas fa-info-circle text-blue-400"></i>
                            Accepted file extensions: 
                            <code class="bg-blue-100 px-2 py-1 rounded mt-1 block">_R1/_R2.fastq.gz</code>
                            <code class="bg-blue-100 px-2 py-1 rounded mt-1 block">.fastq.gz</code>
                        </p>
                    </div>
                    <!-- Warning about human sequences -->
                    <div class="mt-2 text-yellow-700 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                        <p class="flex items-start">
                            <i class="fas fa-exclamation-triangle mt-1 mr-2"></i>
                            <span>
                                <strong>Important:</strong> Please ensure all human sequences have been removed from your samples before
                                uploading to IRIDA. Uploading human sequence data may violate privacy regulations. You can use this pipeline to remove human sequences <a href="https://galaxy.quadram.ac.uk/nextflow/#!run/Human_Reads_Removal%400.1.0" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">https://galaxy.quadram.ac.uk/nextflow/#!run/Human_Reads_Removal</a>
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% csrf_token %}
    
    <!-- Notifications -->
    <div class="mb-6">
        <div class="bg-blue-50 p-4 rounded-lg shadow-sm">
            <h3 class="text-blue-800 font-semibold text-lg mb-2">Upload Queue Status</h3>
            <div x-data="{ 
                queueInfo: null, 
                error: null,
                
                async updateQueueInfo() {
                    try {
                        const response = await fetch('{% url 'uploader:get_queue_info' %}');
                        const data = await response.json();
                        this.queueInfo = data;
                        this.error = data.error || null;
                    } catch (err) {
                        console.error('Error fetching queue info:', err);
                        this.error = err.message;
                    }
                }
            }" 
            x-init="
                updateQueueInfo();
                setInterval(() => updateQueueInfo(), 5000);
            ">
                <!-- Queue Summary -->
                <div class="text-blue-700">
                    <!-- Error Message -->
                    <div x-show="error" class="text-red-600 mb-2" x-text="error"></div>
                    
                    <!-- Queue Info -->
                    <div x-show="queueInfo !== null">
                        <p class="font-medium mb-2">
                            <span x-text="queueInfo?.total_in_queue || 0"></span> uploads in queue
                        </p>
                        <div class="space-y-1">
                            <template x-for="(task, index) in queueInfo?.tasks || []" :key="task.id || index">
                                <div class="ml-4 text-sm flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="mr-2" x-text="`${index + 1}.`"></span>
                                        <span x-text="task.folder_name"></span>
                                        <span class="ml-2 px-2 py-0.5 text-xs rounded-full" 
                                              :class="{
                                                  'bg-yellow-100 text-yellow-800': task.status === 'submitted',
                                                  'bg-green-100 text-green-800': task.status === 'active',
                                                  'bg-blue-100 text-blue-800': task.status === 'reserved',
                                                  'bg-purple-100 text-purple-800': task.status === 'scheduled'
                                              }"
                                              x-text="task.status">
                                        </span>
                                    </div>
                                    <span class="text-gray-500 text-xs" x-text="task.user"></span>
                                </div>
                            </template>
                            <div x-show="queueInfo?.tasks?.length === 0" class="text-gray-500 italic mt-2">
                                No uploads currently in queue
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div x-show="queueInfo === null" class="flex items-center space-x-2">
                        <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Loading queue information...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Notifications</h2>
        <div class="space-y-4">
            <template x-for="notification in notifications" :key="notification.id">
                <div :class="{
                    'bg-green-100': notification.type === 'success', 
                    'bg-red-100': notification.type === 'error',
                    'bg-blue-100': notification.type === 'info'
                }" class="p-4 rounded-lg shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 x-text="notification.title" class="font-semibold" :class="{
                                'text-green-800': notification.type === 'success',
                                'text-red-800': notification.type === 'error',
                                'text-blue-800': notification.type === 'info'
                            }"></h3>
                            <p x-text="notification.message" class="text-sm" :class="{
                                'text-green-700': notification.type === 'success',
                                'text-red-700': notification.type === 'error',
                                'text-blue-700': notification.type === 'info'
                            }"></p>
                            <span x-text="new Date(notification.created_at).toLocaleString()" class="text-xs text-gray-500"></span>
                        </div>
                        <button @click="markNotificationRead(notification.id)" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </template>
            <div x-show="notifications.length === 0" class="text-gray-500 text-center py-4">
                No new notifications
            </div>
        </div>
    </div>

    <!-- Upload History -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                <h2 class="text-lg font-medium text-gray-900">Upload History</h2>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                    <div class="relative flex-grow sm:flex-grow-0 sm:min-w-[300px]">
                        <form @submit="submitSearch" class="flex">
                            <input type="text" 
                                   x-model="searchQuery"
                                   placeholder="Search by folder name, project name, or date..." 
                                   class="block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-l-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <button type="submit" class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 text-sm font-medium rounded-r-md text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <i class="fas fa-search"></i>
                            </button>
                        </form>
                    </div>
                    <button @click="showUploadModal = true" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 w-full sm:w-auto justify-center">
                        <i class="fas fa-upload mr-2"></i>
                        New Upload
                    </button>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Folder</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Samples</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="upload in uploads" :key="upload.id">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="upload.folder_name"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="upload.project_name || '-'"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <template x-if="upload.irida_project_id !== '-'">
                                    <a :href="`{{ irida_base_url }}/projects/${upload.irida_project_id}`"
                                       class="text-blue-600 hover:text-blue-800 hover:underline"
                                       target="_blank"
                                       x-text="upload.irida_project_id">
                                    </a>
                                </template>
                                <template x-if="upload.irida_project_id === '-'">
                                    <span>-</span>
                                </template>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <span x-text="upload.file_count"></span>
                                <span class="text-gray-400 ml-1">samples</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex flex-col gap-2">
                                    <!-- Status badge -->
                                    <span class="px-3 py-1 inline-flex items-center text-sm leading-5 font-medium rounded-full w-fit"
                                        :class="{
                                            'bg-green-100 text-green-800': upload.status === 'success',
                                            'bg-red-100 text-red-800': upload.status === 'failed',
                                            'bg-yellow-100 text-yellow-800': upload.status === 'uploading',
                                            'bg-blue-100 text-blue-800': upload.status === 'submitted'
                                        }">
                                        <i class="mr-1.5 text-xs"
                                           :class="{
                                               'fas fa-check': upload.status === 'success',
                                               'fas fa-times': upload.status === 'failed',
                                               'fas fa-sync fa-spin': upload.status === 'uploading',
                                               'fas fa-clock': upload.status === 'submitted'
                                           }">
                                        </i>
                                        <span x-text="upload.status.charAt(0).toUpperCase() + upload.status.slice(1)"></span>
                                    </span>

                                    <!-- Progress bar outside the status badge -->
                                    <div x-show="upload.sample_progress" class="w-full">
                                        <div class="text-xs font-medium text-gray-600 mb-1">
                                            <span x-text="(upload.sample_progress && upload.sample_progress.uploaded) || 0"></span>
                                            <span class="text-gray-400">/</span>
                                            <span x-text="(upload.sample_progress && upload.sample_progress.total) || 0"></span>
                                        </div>
                                        
                                        <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                            <div class="h-full bg-yellow-500 rounded-full transition-all duration-500"
                                                 :style="`width: ${(upload.sample_progress && upload.sample_progress.total) ? (upload.sample_progress.uploaded / upload.sample_progress.total) * 100 : 0}%`">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="new Date(upload.created_at).toLocaleString()"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button @click="uploadLogs = []; updateUploadStatus(upload.id); showLogs = true" 
                                        class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-eye mr-1"></i>View Logs
                                </button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="uploads.length === 0">
                        <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                            No uploads found
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if uploads.has_previous %}
                <button @click="goToPage('{{ uploads.previous_page_number }}')" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Previous
                </button>
                {% endif %}
                {% if uploads.has_next %}
                <button @click="goToPage('{{ uploads.next_page_number }}')" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Next
                </button>
                {% endif %}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Page {{ uploads.number }} of {{ uploads.paginator.num_pages }}
                        ({{ uploads.paginator.count }} total results)
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if uploads.has_previous %}
                        <button @click="goToPage('{{ uploads.previous_page_number }}')" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        {% endif %}
                        
                        {% for page_num in uploads.paginator.page_range %}
                            {% if page_num == "..." %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                ...
                            </span>
                            {% else %}
                            <button @click="goToPage('{{ page_num }}')" 
                                    class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium
                                    {% if page_num == uploads.number %}
                                        z-10 bg-blue-50 border-blue-500 text-blue-600
                                    {% else %}
                                        bg-white text-gray-500 hover:bg-gray-50
                                    {% endif %}">
                                {{ page_num }}
                            </button>
                            {% endif %}
                        {% endfor %}
                        
                        {% if uploads.has_next %}
                        <button @click="goToPage('{{ uploads.next_page_number }}')" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Redesigned Upload Logs -->
    <div x-show="uploadLogs.length > 0" class="mt-8">
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <button @click="showLogs = !showLogs" 
                    class="w-full px-4 py-3 flex justify-between items-center hover:bg-gray-50 focus:outline-none">
                <div class="flex items-center">
                    <i class="fas fa-terminal text-gray-400 mr-2"></i>
                    <h2 class="text-lg font-medium text-gray-900">Upload Logs</h2>
                    <span class="ml-2 px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600" 
                          x-text="`${uploadLogs.length} entries`"></span>
                </div>
                <i class="fas transition-transform duration-200" 
                   :class="showLogs ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </button>
            
            <div x-show="showLogs" 
                 x-transition:enter="transition ease-out duration-200" 
                 x-transition:enter-start="opacity-0 transform -translate-y-2" 
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-y-0"
                 x-transition:leave-end="opacity-0 transform -translate-y-2"
                 class="border-t border-gray-200"
                 x-cloak>
                <div class="p-4">
                    <div class="bg-gray-900 text-green-400 font-mono text-sm p-4 rounded-lg max-h-96 overflow-y-auto logs-container">
                        <template x-for="(log, index) in uploadLogs" :key="index">
                            <div x-text="log" class="whitespace-pre-wrap leading-relaxed"></div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div x-show="showUploadModal" 
         x-cloak
         @keydown.escape.window="showUploadModal = false"
         class="fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
             @click.away="showUploadModal = false">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <div class="px-6 py-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-medium">Upload Files from Folder</h3>
                                    <div class="flex items-center gap-2">
                                        <button @click="refreshFolders" 
                                                class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                                :disabled="loading">
                                            <i class="fas fa-sync-alt mr-2" :class="{ 'animate-spin': loading }"></i>
                                            Refresh
                                        </button>
                                        <button @click="showUploadModal = false" class="text-gray-400 hover:text-gray-500">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700">Select Folder</label>
                                    <select x-model="selectedFolder" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                        <option value="">Choose a folder</option>
                                        <template x-for="folder in folders" :key="folder">
                                            <option x-text="folder" :value="folder"></option>
                                        </template>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700">Project Prefix</label>
                                    <input type="text" x-model="projectPrefix" 
                                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                                        placeholder="QIB">
                                    <p class="mt-1 text-sm text-gray-500">Will be prepended to project name (e.g. QIB-MyProject). The prefix is used to identify who was sequencing provider, i.e QIB for in-house sequencing, Novogene for Novogene.</p>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700">Project Name (Optional)</label>
                                    <input type="text" x-model="projectName" 
                                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                                        placeholder="Leave empty to use folder name">
                                    
                                    <!-- Add toggle switch for date append -->
                                    <div class="mt-2 flex items-center justify-between p-2 rounded-lg bg-gray-50">
                                        <div class="flex items-center">
                                            <i class="fas fa-calendar-alt text-gray-500 mr-2"></i>
                                            <span class="text-sm text-gray-700 font-medium">Append date to project name</span>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" x-model="appendDate" class="sr-only">
                                            <div class="relative w-14 h-7 rounded-full transition-colors duration-200"
                                                 :class="appendDate ? 'bg-blue-600' : 'bg-gray-200'">
                                                <div class="absolute inset-y-0 left-0 w-6 h-6 m-0.5 bg-white rounded-full 
                                                            transform transition-transform duration-200 border border-gray-300"
                                                     :class="appendDate ? 'translate-x-7' : 'translate-x-0'">
                                                </div>
                                            </div>
                                            <span class="ml-2 text-sm font-medium" 
                                                  :class="appendDate ? 'text-blue-600' : 'text-gray-500'"
                                                  x-text="appendDate ? 'On' : 'Off'">
                                            </span>
                                        </label>
                                    </div>

                                    <p class="mt-1 text-sm text-gray-500">
                                        Final name will be: 
                                        <span x-text="
                                            (() => {
                                                const d = new Date();
                                                const dateStr = appendDate ? 
                                                    '-' + d.getFullYear().toString().slice(-2) + 
                                                    String(d.getMonth() + 1).padStart(2, '0') + 
                                                    String(d.getDate()).padStart(2, '0') : '';
                                                return projectPrefix + '-' + 
                                                       (projectName ? projectName : selectedFolder.replace(/_/g, '-')) + 
                                                       dateStr;
                                            })()
                                        "></span>
                                    </p>
                                </div>

                                <div x-show="error" class="mt-4 text-sm text-red-600" x-text="error"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="startUpload(false)" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Start Upload
                    </button>
                    <button @click="showUploadModal = false" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Force Upload Confirmation Modal -->
    <div x-show="showForceUploadConfirm" 
         x-cloak
         class="fixed z-20 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Folder Already Uploaded
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    This folder has already been uploaded with <span x-text="sampleCount"></span> samples. Do you want to upload it again?
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="startUpload(true)" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-yellow-600 text-base font-medium text-white hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Yes, Upload Again
                    </button>
                    <button @click="showForceUploadConfirm = false; showUploadModal = true" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %} 